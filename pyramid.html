<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Carers in Australia (ABS 2022) — % by Age & Sex</title>
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #vis { width: 100%; max-width: 900px; margin: auto; }
  </style>
</head>
<body>
  <h1>Carers in Australia (ABS 2022) — % by Age & Sex</h1>
  <div id="vis"></div>

  <script>
    const spec = {
      "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
      "width": 860,
      "height": 520,
      "data": {
        "url": "data/proportioncare.csv",
        "format": {
          "type": "csv",
          "parse": {
            "Males (%)": "number",
            "Females (%)": "number",
            "CI Male low": "number",
            "CI Male high": "number",
            "CI Female low": "number",
            "CI Female high": "number"
          }
        }
      },
      "transform": [
        // Filter out invalid rows
        { "filter": "datum['Age group'] && datum['Age group'] !== 'Source:'" },
        // Fold Males (%) and Females (%) into long format
        { "fold": ["Males (%)", "Females (%)"], "as": ["sex_raw", "pct"] },
        // Create signed values for pyramid (males negative, females positive)
        { "calculate": "datum.sex_raw === 'Males (%)' ? -datum.pct : datum.pct", "as": "signed" },
        // Simplify sex labels
        { "calculate": "datum.sex_raw === 'Males (%)' ? 'Male' : 'Female'", "as": "Sex" }
      ],
      "params": [
        { 
          "name": "sexSel", 
          "select": { "type": "point", "fields": ["Sex"] }, 
          "bind": "legend" 
        }
      ],
      "layer": [
        {
          "mark": "bar",
          "encoding": {
            "y": {
              "field": "Age group",
              "type": "ordinal",
              "sort": [
                "Less than 15",
                "15–24",
                "25–34",
                "35–44",
                "45–54",
                "55–64",
                "65–74",
                "75 and over"
              ],
              "title": "Age group"
            },
            "x": {
              "field": "signed",
              "type": "quantitative",
              "axis": { "title": "% of persons who are carers", "format": ".0f" }
            },
            "color": {
              "field": "Sex",
              "type": "nominal",
              "title": "Sex",
              "scale": { "domain": ["Male", "Female"], "range": ["#1f77b4", "#ff7f0e"] }
            },
            "opacity": { 
              "condition": { "param": "sexSel", "value": 1 }, 
              "value": 0.35 
            },
            "tooltip": [
              { "field": "Age group", "title": "Age" },
              { "field": "Sex" },
              { "field": "pct", "title": "Carers (%)", "format": ".1f" }
            ]
          }
        },
        // Zero line
        { 
          "mark": { "type": "rule", "stroke": "#555" }, 
          "encoding": { "x": { "value": 0 } } 
        }
      ],
      "config": { "view": { "stroke": null } }
    };

    vegaEmbed('#vis', spec, { actions: true })
      .then(result => {
        console.log('Vega Embed Success:', result);
        // Log loaded data to verify
        result.view.data('source_0').then(data => console.log('Loaded Data:', data));
      })
      .catch(err => console.error('Vega Embed Error:', err));
  </script>
</body>
</html>



